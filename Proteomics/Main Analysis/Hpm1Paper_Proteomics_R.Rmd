---
title: "Quantitative proteomic analysis"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r}
library(proteus)
library(ggplot2)
library(tidyverse)
library(ggrepel)
library(extrafont)
loadfonts(device = "pdf")
```

MaxQuant output, and Proteus metadata file with experimental design
```{r}
#download the evidence_Proteomics.txt from the PRIDE repository to repeat this analysis
Both <- read.table("../Data/MaxQuant/evidence.txt", sep="\t", fill = TRUE, header = TRUE, na.strings = "")
meta <- read.delim2("../metadata.txt", sep = "\t")
```


FWD means the hpm1 strain was heavy labelled and wild-type was light labelled.
RV is opposite labelling.
```{r}
Both <- Both%>% 
  filter(is.na(Reverse)) %>% 
  filter(is.na(Potential.contaminant))


FWD_1 <- Both %>% 
  filter(str_detect(Raw.file, "FWD")) %>% 
  filter(str_detect(Raw.file, "_1")) %>% 
  mutate(experiment = "FWD_1") %>% 
  mutate(ratio = Ratio.H.L.normalized)

FWD_2 <- Both %>% 
  filter(str_detect(Raw.file, "FWD")) %>% 
  filter(str_detect(Raw.file, "_2")) %>% 
  mutate(experiment = "FWD_2") %>% 
  mutate(ratio = Ratio.H.L.normalized)

RV_1 <- Both %>% 
  filter(str_detect(Raw.file, "RV")) %>% 
  filter(str_detect(Raw.file, "_1")) %>% 
  mutate(experiment = "RV_1") %>% 
  mutate(logratio = -1*log2(Ratio.H.L.normalized)) %>% 
  mutate(ratio = 2^logratio)

RV_2 <- Both %>% 
  filter(str_detect(Raw.file, "RV")) %>% 
  filter(str_detect(Raw.file, "_2")) %>% 
  mutate(experiment = "RV_2") %>% 
  mutate(logratio = -1*log2(Ratio.H.L.normalized)) %>% 
  mutate(ratio = 2^logratio)


evi <- bind_rows(FWD_1, FWD_2, RV_1, RV_2)

```

```{r}
measCols <- list(
  ratio = "ratio"
)

evi <- evi %>% 
  rename(sequence = 'Sequence',
         modified_sequence = 'Modified.sequence',
         modifications = 'Modifications',
         protein_group = 'Proteins',
         protein = 'Leading.razor.protein',
         experiment = 'experiment',
         charge = 'Charge',
         reverse = 'Reverse',
         contaminant = 'Potential.contaminant'
)
```

Summarise peptides to the protein level
```{r}
eviWithMoreThanOneRatio <- evi %>%
 filter(ratio != "NaN") %>%
 group_by(protein) %>%
 summarise(NumRatio = n()) %>%
 ungroup() %>%
 filter(NumRatio > 1)

evi <-   inner_join(evi, eviWithMoreThanOneRatio)

pepdat <- makePeptideTable(evi, meta, measure.cols=measCols, aggregate.fun=aggregateMedian, experiment.type="SILAC")

summary(pepdat)
plotCount(pepdat)

prodat <- makeProteinTable(pepdat, aggregate.fun=aggregateMedian, min.peptides = 2)
summary(prodat)

plotPCA(pepdat)
```

Normalise protein ratios to account for mixing
```{r}
prodat.norm <- normalizeData(prodat)

plotSampleDistributions(prodat, fill="replicate") + labs(title="Before")
plotSampleDistributions(prodat.norm, fill="replicate") + labs(title="After")

res <- limmaRatioDE(prodat.norm, condition="Hpm1_WT")
res <- res[order(res$P.Value),]
res

NumberQuantifiedProteins <- res %>% 
  filter(!is.na(logFC))

```

Annotating protein information to and filtering results
```{r}
cutoff = 1.0

results <- res %>% 
  mutate(color = case_when(
    adj.P.Val <= 0.05 & logFC <= -cutoff ~ "red", 
    adj.P.Val <= 0.05 & logFC >= cutoff ~ "green",
    adj.P.Val <= 0.05 & abs(logFC < cutoff) ~ "grey",
    adj.P.Val > 0.05 ~ "grey")) %>% 
  mutate(log10adjpvalue = -1* log10(adj.P.Val)) %>% 
  mutate(label = if_else(adj.P.Val <= 0.05 & (abs(logFC) >= cutoff), TRUE, FALSE)) %>% 
  mutate(alpha = if_else(adj.P.Val <= 0.05 & (abs(logFC) >= cutoff), 1, 0.5)) %>% 
  filter(!is.na(adj.P.Val))

UNIPROT <- read.delim("../Data/UniProt/UNIPROT_Yeast.txt", stringsAsFactors=FALSE)

results <- left_join(results, UNIPROT, by = c("protein" = "Entry"))

results <- results %>% 
  mutate(LabelName = if_else(Gene.names...primary..== "", Gene.names...ordered.locus.., Gene.names...primary..)) %>% 
  mutate(LabelName = paste0(str_to_sentence(LabelName, locale = "en"), "p"))

resultsFiltered <- results %>% 
  filter(label == TRUE) %>% 
  select(protein, logFC, ngood, adj.P.Val, Gene.names...ordered.locus..)

resultsFilteredAllSig <- results %>% 
  filter(significant == TRUE) %>% 
  select(protein, logFC, ngood, adj.P.Val, Gene.names...ordered.locus..)


write.table(results, file = "AllProteins.txt", row.names = FALSE, quote = FALSE, sep = "\t")
write.table(resultsFiltered, file = "MostChangingProteins.txt", row.names = FALSE, quote = FALSE, sep = "\t")
write.table(resultsFilteredAllSig, file = "AllChangingProteins.txt", row.names = FALSE, quote = FALSE, sep = "\t")

```

Generating Volcano plot
```{r}
ggplot(results, aes(x=logFC, y=log10adjpvalue, color = color, text = protein, label = LabelName, alpha =alpha)) +
  geom_point() +
  geom_text_repel(data = subset(results, label == TRUE), size = 3) +
  xlim(c(-4.2,1.3)) +
labs(x = expression(Log[2]~fold~change), y = expression(Log[10]~adjusted~p-value)) + 
 scale_color_manual(values = c("#D90000", "#bababa", "#00429d")) +
  theme_bw() +
  theme(legend.position = "none", text=element_text(size=10,  family="Arial"), panel.border = element_rect(fill=NA, colour = "black", size=1))
  
ggsave(filename = "ProtoemicsVolcano.pdf", device = cairo_pdf, 
       width = 3, height = 3, units = "in")
```

Annotating ribosomal protein changes
```{r}
cytoriboproteins <- UNIPROT %>% 
  filter(str_detect(Protein.names, fixed("ribosomal protein", ignore_case = TRUE))) %>% 
  filter(!str_detect(Protein.names, fixed("mitochondrial", ignore_case = TRUE)))

cytoriboproteins <- as.list(cytoriboproteins$Entry)


Ribo_results <- res %>% 
  mutate(color = protein %in% cytoriboproteins) %>% 
  mutate(log10adjpvalue = -1* log10(adj.P.Val)) %>% 
  mutate(label = if_else(color == TRUE, TRUE, FALSE)) %>% 
  mutate(alpha = if_else(color == TRUE, 1, 0.1)) %>% 
  filter(!is.na(adj.P.Val)) %>% 
  arrange(color) %>% 
  mutate(Name = case_when(
    color == FALSE ~ "Non-ribosomal",
    ((color == TRUE) &(adj.P.Val > 0.05)) ~ "Ribosomal, n.s",
    ((color == TRUE) &(adj.P.Val <= 0.05)) ~ "Ribosomal, sig.")) %>% 
  ungroup()

Ribo_results <- left_join(Ribo_results, UNIPROT, by = c("protein" = "Entry"))

ggplot(Ribo_results, aes(x = logFC, y = Name, fill = Name)) +
  geom_violin(aes(alpha = 0.6)) +
     theme_bw() +
  xlim(-5,5) +
  scale_fill_manual(values = c("#bababa", "#BACDE6", "#00429d", "#00429d")) +
  labs(x = expression(Log[2]~fold~change), y = "") + 
  theme(legend.position = "none", 
        text=element_text(size=10,  family="Arial"), 
        panel.border = element_rect(fill=NA, colour = "black", size=1),
        axis.text.x = element_text(angle =45, hjust = 1, vjust = 1)) +
  coord_flip()

ggsave(filename = "RibosomalProteinChanges.pdf", device = cairo_pdf, 
       width = 1.5, height = 2.7, units = "in")


```

Comparing the ratios for cytoplasmic ribosomal proteins with that of the rest of the proteins analysed
```{r}
Ribo <- Ribo_results %>% 
  filter(color == TRUE)
Other <- Ribo_results %>% 
  filter(color == FALSE)
wilcox.test(Ribo$logFC, Other$logFC)


SigRibo <- Ribo_results %>% 
  filter(color == TRUE) %>% 
  filter(adj.P.Val <= 0.05) 

NonSigRibo <- Ribo_results %>% 
  filter(color == TRUE) %>% 
  filter(adj.P.Val > 0.05) 

wilcox.test(Other$logFC, NonSigRibo$logFC)
wilcox.test(SigRibo$logFC, NonSigRibo$logFC)

mean(results$logFC)

write.csv(Ribo, file = "Ribo_Proteins.csv", row.names = FALSE, quote = FALSE)
```


